<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Using clusto &mdash; clusto v0.5.27 documentation</title>
    <link rel="stylesheet" href="static/default.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.5.27',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <link rel="top" title="clusto v0.5.27 documentation" href="index.html" />
    <link rel="next" title="Services" href="services.html" />
    <link rel="prev" title="Tutorial" href="tutorial.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="services.html" title="Services"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="tutorial.html" title="Tutorial"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">clusto v0.5.27 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="using-clusto">
<h1>Using clusto<a class="headerlink" href="#using-clusto" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Release:</th><td class="field-body">0.5</td>
</tr>
<tr class="field"><th class="field-name">Date:</th><td class="field-body">May 06, 2010</td>
</tr>
</tbody>
</table>
<p>In order to use clusto, you&#8217;ll have to make it aware of your server environment. Every environment is built differently and may require different approaches to the discovery of servers and usage of clusto&#8217;s features.</p>
<div class="section" id="ipmanagers-for-your-subnets">
<h2>IPManagers for your subnets<a class="headerlink" href="#ipmanagers-for-your-subnets" title="Permalink to this headline">¶</a></h2>
<p>Clusto requires that every IP address you bind to a server must be associated with an IPManager instance for that subnet. This allows you to do dynamic allocation of addresses and associate related information (eg. netmask, broadcast) with every address. These features are especially useful when using clusto&#8217;s DHCP server.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">from</span> <span class="nn">clusto.drivers</span> <span class="k">import</span> <span class="n">IPManager</span>
<span class="n">ipman</span> <span class="o">=</span> <span class="n">IPManager</span><span class="p">(</span><span class="s">&#39;subnet-dmz&#39;</span><span class="p">,</span> <span class="n">baseip</span><span class="o">=</span><span class="s">&#39;192.168.20.0&#39;</span><span class="p">,</span> <span class="n">netmask</span><span class="o">=</span><span class="s">&#39;255.255.252.0&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="simpleentitynamemanager">
<h2>SimpleEntityNameManager<a class="headerlink" href="#simpleentitynamemanager" title="Permalink to this headline">¶</a></h2>
<p>In order to automatically discover and create new server objects, Clusto needs to be able to generate new names for objects. SimpleEntityNameManagers provide an allocate(Driver) method that creates a new instance and generates a name for it.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">from</span> <span class="nn">clusto.drivers</span> <span class="k">import</span> <span class="n">SimpleEntityNameManager</span><span class="p">,</span> <span class="n">PenguinServer</span>

<span class="n">names</span> <span class="o">=</span> <span class="n">SimpleEntityNameManager</span><span class="p">(</span><span class="s">&#39;servernames&#39;</span><span class="p">,</span> <span class="n">basename</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="n">digits</span><span class="o">=</span><span class="mf">4</span><span class="p">)</span>
<span class="n">server</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">PenguinServer</span><span class="p">)</span>
</pre></div>
</div>
<p>This will create a new server instance with a name like &#8220;s0000&#8221;</p>
</div>
<div class="section" id="creating-a-datacenter">
<h2>Creating a datacenter<a class="headerlink" href="#creating-a-datacenter" title="Permalink to this headline">¶</a></h2>
<p>Clusto comes ready to use with Basic drivers for a variety of entities and devices most systems engineers are familiar with. These Basic drivers can be used directly if only basic functionality is desired, but are intended to be subclassed and overridden with different variables and method. It is considered a best practice to create subclasses in case you need to customize a driver later on.
This is an example of a custom datacenter driver representing a colocation facility. (src/clusto/drivers/locations/datacenters/equinixdatacenter.py):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">from</span> <span class="nn">basicdatacenter</span> <span class="k">import</span> <span class="n">BasicDatacenter</span>

<span class="k">class</span> <span class="nc">EquinixDatacenter</span><span class="p">(</span><span class="n">BasicDatacenter</span><span class="p">):</span>
       <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">       Equinix datacenter driver</span>
<span class="sd">       &#39;&#39;&#39;</span>

       <span class="n">_driver_name</span> <span class="o">=</span> <span class="s">&#39;equinixdatacenter&#39;</span>
</pre></div>
</div>
<p>Add the following to src/clusto/drivers/locations/datacenters/__init__.py:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">from</span> <span class="nn">equinixdatacenter</span> <span class="k">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>This subclass is an example of a simple wrapper that does not provide additional functionality beyond distinguishing this type of datacenter from another one.</p>
<p>At clusto&#8217;s core, it&#8217;s a tool for gluing together other services, protocols, and logic in a data-centric way. An example of such usage would be a method that opens a ticket with the colo provider for a remote hands action. Add the following to equinixdatacenter.py:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">from</span> <span class="nn">smtplib</span> <span class="k">import</span> <span class="n">SMTP</span>
<span class="k">def</span> <span class="nf">remote_hands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s">&#39;low&#39;</span><span class="p">,</span> <span class="n">mail_server</span><span class="o">=</span><span class="s">&#39;mail.example.com&#39;</span><span class="p">,</span> <span class="n">mail_from</span><span class="o">=</span><span class="s">&#39;clusto@example.com&#39;</span><span class="p">,</span> <span class="n">mail_to</span><span class="o">=</span><span class="s">&#39;remotehands@datacenter.net&#39;</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;From: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">To: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">Subject: Remote hands request: </span><span class="si">%s</span><span class="s"> priority</span><span class="se">\r\n\r\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mail_from</span><span class="p">,</span> <span class="n">mail_to</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">SMTP</span><span class="p">(</span><span class="n">mail_server</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">mail_from</span><span class="p">,</span> <span class="n">mail_to</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</pre></div>
</div>
<p>Using clusto-shell we can instantiate our new datacenter and test the remote_hands method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">from</span> <span class="nn">clusto.drivers</span> <span class="k">import</span> <span class="n">EquinixDatacenter</span>

<span class="n">datacenter</span> <span class="o">=</span> <span class="n">EquinixDatacenter</span><span class="p">(</span><span class="s">&#39;eqix-sv3&#39;</span><span class="p">)</span>
<span class="n">datacenter</span><span class="o">.</span><span class="n">remote_hands</span><span class="p">(</span><span class="s">&#39;Turn on power for new racks in my cage&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s">&#39;high&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="adding-racks-to-the-datacenter">
<h2>Adding racks to the datacenter<a class="headerlink" href="#adding-racks-to-the-datacenter" title="Permalink to this headline">¶</a></h2>
<p>Rack factories are fairly specific to each organization&#8217;s environment... Common rack layouts are uncommon. For these types of highly-customized features, you&#8217;ll need to modify the files in /var/lib/clusto to suit your needs. Clusto ships with some examples of the files used by Digg.</p>
<p>Take a look at /var/lib/clusto/rackfactory.py to get an idea of how to programatically define rack layouts.</p>
<p>Continuing our example from above, let&#8217;s assume the remote hands at the datacenter plugged in your new rack and closed the ticket. Now you want to be able to manipulate the rack in clusto and start adding servers to it. Let&#8217;s go back to clusto-shell:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">from</span> <span class="nn">clusto.drivers</span> <span class="k">import</span> <span class="n">APCRack</span>

<span class="n">rack</span> <span class="o">=</span> <span class="n">APCRack</span><span class="p">(</span><span class="s">&#39;sv3-001&#39;</span><span class="p">)</span>
<span class="n">rack</span><span class="o">.</span><span class="n">set_attr</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s">&#39;racklayout&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s">&#39;201001&#39;</span><span class="p">)</span>
<span class="n">datacenter</span> <span class="o">=</span> <span class="n">get_by_name</span><span class="p">(</span><span class="s">&#39;eqix-sv3&#39;</span><span class="p">)</span>
<span class="n">datacenter</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">rack</span><span class="p">)</span>
</pre></div>
</div>
<p>That&#8217;s all you need to do to create a new rack instance and insert it into a datacenter. The set_attr for rack layout will be explained in the following section.</p>
</div>
<div class="section" id="rack-factory">
<h2>Rack factory<a class="headerlink" href="#rack-factory" title="Permalink to this headline">¶</a></h2>
<p>If you have more than one rack using the same layout of devices and connections between them, clusto can ease a lot of the data entry involved with creating and populating new racks with custom RackFactory classes:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">from</span> <span class="nn">rackfactory</span> <span class="k">import</span> <span class="n">get_factory</span>

<span class="n">factory</span> <span class="o">=</span> <span class="n">get_factory</span><span class="p">(</span><span class="s">&#39;sv3-001&#39;</span><span class="p">)</span>
<span class="n">factory</span><span class="o">.</span><span class="n">connect_ports</span><span class="p">()</span>
</pre></div>
</div>
<p>The get_factory call will get the &#8216;sv3-001&#8217; rack instance from clusto and lookup an attribute of key=&#8217;rackfactory&#8217; to determine which factory class should be used to fill in the rest of the information. The __init__ method of Digg201001RackFactory also creates network, console, and power switch instances with names based on the name of the rack.</p>
<p>The connect_ports method ensures that this rack is in the datacenter, that the network, console, and power instances are in this rack, and that their ports are all connected as intended. This gives us the basic structure of everything that will be identical across all racks with this layout.</p>
</div>
<div class="section" id="virtual-machines">
<h2>Virtual machines<a class="headerlink" href="#virtual-machines" title="Permalink to this headline">¶</a></h2>
<p>Clusto supports managing virtual machines and their host environments through subclasses of VMManager. At the time of writing the only working implementation is XenVMManager.</p>
<p>Assuming you already have some server objects and you&#8217;ve installed Xen with libvirtd on those servers, with an LVM volume group named &#8220;vg0&#8221;, the clusto side of things goes a bit like this:</p>
<div class="highlight-python"><pre>from clusto.drivers import XenVMManager, XenVirtualServer

hosts = [
       clusto.get_by_name('xenhost1')
       clusto.get_by_name('xenhost2')
       clusto.get_by_name('xenhost3')
]

# Every hypervisor MUST have the following four attributes set
for x in hosts:
       x.set_attr(key='xen', subkey='volume-group', value='vg0')   # LVM VG name
       x.set_attr(key='system', subkey='memory', value=16384)      # RAM in MB
       x.set_attr(key='system', subkey='disk', value=2000)         # Disk in GB
       x.set_attr(key='system', subkey='cpucount', value=8)        # Logical CPUs

manager = XenVMManager('xenmanager')
[manager.insert(x) for x in hosts]</pre>
</div>
<p>Now that you have your host machines configured, allocate a new VM:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">vm</span> <span class="o">=</span> <span class="n">XenVirtualServer</span><span class="p">(</span><span class="s">&#39;xenvm1&#39;</span><span class="p">)</span>
<span class="n">vm</span><span class="o">.</span><span class="n">bind_ip_to_osport</span><span class="p">(</span><span class="s">&#39;192.168.1.51&#39;</span><span class="p">,</span> <span class="s">&#39;eth0&#39;</span><span class="p">)</span>
<span class="n">vm</span><span class="o">.</span><span class="n">set_port_attr</span><span class="p">(</span><span class="s">&#39;nic-eth&#39;</span><span class="p">,</span> <span class="mf">1</span><span class="p">,</span> <span class="s">&#39;mac&#39;</span><span class="p">,</span> <span class="s">&#39;02:52:0a:00:00:01&#39;</span><span class="p">)</span>
<span class="n">vm</span><span class="o">.</span><span class="n">set_attr</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s">&#39;system&#39;</span><span class="p">,</span> <span class="n">subkey</span><span class="o">=</span><span class="s">&#39;memory&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1024</span><span class="p">)</span>
<span class="n">vm</span><span class="o">.</span><span class="n">set_attr</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s">&#39;system&#39;</span><span class="p">,</span> <span class="n">subkey</span><span class="o">=</span><span class="s">&#39;disk&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">20</span><span class="p">)</span>
<span class="n">vm</span><span class="o">.</span><span class="n">set_attr</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s">&#39;system&#39;</span><span class="p">,</span> <span class="n">subkey</span><span class="o">=</span><span class="s">&#39;cpucount&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1</span><span class="p">)</span>
<span class="n">manager</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span><span class="n">vm</span><span class="p">)</span>

<span class="n">vm</span><span class="o">.</span><span class="n">vm_create</span><span class="p">()</span>         <span class="c"># Create the LVM logical volumes, define the domain</span>
<span class="n">vm</span><span class="o">.</span><span class="n">vm_start</span><span class="p">()</span>          <span class="c"># Start the defined domain</span>
<span class="n">vm</span><span class="o">.</span><span class="n">vm_console</span><span class="p">()</span>        <span class="c"># SSH to the host and open the VM&#39;s console</span>
<span class="n">vm</span><span class="o">.</span><span class="n">vm_stop</span><span class="p">()</span>           <span class="c"># Shutdown the VM</span>
</pre></div>
</div>
<p>If you already have IPManager and SimpleEntityNameManager instances setup, the command line tools should work as well:</p>
<div class="highlight-python"><pre>$ clusto vm create --disk 20 --memory 1024
Created v1000
$ clusto vm start v1000</pre>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="">Using clusto</a><ul>
<li><a class="reference external" href="#ipmanagers-for-your-subnets">IPManagers for your subnets</a></li>
<li><a class="reference external" href="#simpleentitynamemanager">SimpleEntityNameManager</a></li>
<li><a class="reference external" href="#creating-a-datacenter">Creating a datacenter</a></li>
<li><a class="reference external" href="#adding-racks-to-the-datacenter">Adding racks to the datacenter</a></li>
<li><a class="reference external" href="#rack-factory">Rack factory</a></li>
<li><a class="reference external" href="#virtual-machines">Virtual machines</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="tutorial.html"
                                  title="previous chapter">Tutorial</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="services.html"
                                  title="next chapter">Services</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="sources/using.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="services.html" title="Services"
             >next</a> |</li>
        <li class="right" >
          <a href="tutorial.html" title="Tutorial"
             >previous</a> |</li>
        <li><a href="index.html">clusto v0.5.27 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2010, Digg, Inc..
      Last updated on May 06, 2010.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.3.
    </div>
  </body>
</html>